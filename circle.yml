machine:
  services:
    - docker

dependencies:
  cache_directories:
    - "~/docker"
  override:
    - docker info
    - if [[ -e ~/docker/image.tar ]]; then docker load --input ~/docker/image.tar; fi
    - docker build -t android-hello-world -f docker/Dockerfile .
    - mkdir -p ~/docker; docker save android-hello-world > ~/docker/image.tar

test:
  override:
    - ./gradlew testRelease --tests se.paldan.helloworld.ExampleUnitTest;
    - ./gradlew testRelease --tests se.paldan.helloworld.ExampleUnitTestTwo;
    - ./gradlew testRelease --tests se.paldan.helloworld.ExampleUnitTestThree;
    - ./gradlew testRelease --tests se.paldan.helloworld.ExampleUnitTestFour;
    - ./gradlew testRelease --tests se.paldan.helloworld.ExampleUnitTestFive;
    - docker run -d -p 9200:9200 android-hello-world; sleep 10
    - curl --retry 10 --retry-delay 5 -v http://localhost:9200
  post:
    - mkdir -p $CIRCLE_TEST_REPORTS/junit/
    - find . -type f -regex ".*/app/build/test-results/.*xml" -exec cp {} $CIRCLE_TEST_REPORTS/junit/ \;
    - ./gradlew assembleRelease
    - find . -type f -regex ".*/app/build/outputs/.*apk" -exec cp {} $CIRCLE_ARTIFACTS \;
    - if [[ ! -z $CI_PULL_REQUEST ]] ; then   
        echo "Generating test coverage report..." &&
        mkdir -p $CIRCLE_TEST_REPORTS/coverage/ &&
        ./gradlew app:testDebugUnitTestCoverage &&
        find . -type f -regex ".*/app/build/reports/jacoco/testDebugUnitTestCoverage/html/*" -exec cp {} $CIRCLE_TEST_REPORTS/coverage/ \
      fi;
